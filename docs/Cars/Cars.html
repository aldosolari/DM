<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Data Mining</title>
    <meta charset="utf-8" />
    <meta name="author" content="Aldo Solari" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data Mining
## I dati delle automobili
### Aldo Solari

---





# I dati delle automobili

* Tratto dal libro AS, Capitolo 2.1

* I dati delle automobili si riferiscono alle caratteristiche di 203 modelli di automobili importati negli USA nel 1985

* I dati originali sono disponibili qui: [ftp://ftp.ics.uci.edu/pub/machine-learning-databases/autos](ftp://ftp.ics.uci.edu/pub/machine-learning-databases/autos)
Questi dati sono stati elaborati convertendo le unità di misura, eliminado alcune variabili originarie, correggendo alcuni nomi di marche, etc.

* Obiettivo: prevedere il consumo di carburante (o, equivalentemente, la distanza percorsa per unità di carburante) in funzione di determinate caratteristiche di un'automobile

---


* brand   :             manufacturer (factor, 22 levels), casa produttrice (fattore, 22 livelli) 
* fuel    :       type of engine fuel (factor, 2 levels: diesel, gasoline), tipo di alimentazione del motore (fattore, 2 livelli) 
* aspiration :          type of engine aspiration (factor, 2 levels: standard, turbo), tipo di aspirazione del motore (fattore, 2 livelli)   
* bodystyle :         type of body style (factor, 5 levels: hardtop, wagon, sedan, hatchback, convertible),  tipo di carrozzeria (fattore, 5 livelli)  
* drive.wheels :       type of drive wheels (factor,  3 levels: 4wd, fwd, rwd), tipo di trazione (fattore,  3 livelli)    
* engine.location :    location of engine (factor, 2 levels: front, rear), posizione del motore (fattore, 2 livelli)  
* wheel.base :         distance between axes (cm), distanza tra gli assi (cm) 
* length :             length (cm), lunghezza (cm)      
* width :              width (cm), larghezza (cm)    
* height :             height (cm), altezza (cm)    
* curb.weight :        weight (kg), peso (kg)   
* engine size :        engine size (l), cilindrata (l)   
* compression.ratio :   compression ratio, rapporto di compressione   
* HP :                  horsepower, cavalli motore   
* peak.rot     :       number of peak revolutions per minute, numero di giri massimi del motore al minuto    
* __city.distance__ :      city distance covered (km/l), percorrenza urbana (km/l)   
* highway.distance :    highway distance (km/l), percorrenza extra urbana (km/l)  
* n.cylinders  :       number of cylinders, numero di cilindri

---



```r
rm(list=ls())
auto &lt;- read.table("http://azzalini.stat.unipd.it/Book-DM/auto.dat", header=TRUE, quote="\"")
dim(auto)
```

```
[1] 203  18
```

```r
# ci sono dati mancanti?
sum(is.na(auto))
```

```
[1] 0
```


---


```r
# tipologia di variabili
str(auto)
```

```
'data.frame':	203 obs. of  18 variables:
 $ brand            : chr  "alfa-romeo" "alfa-romeo" "alfa-romeo" "audi" ...
 $ fuel             : chr  "gas" "gas" "gas" "gas" ...
 $ aspiration       : chr  "std" "std" "std" "std" ...
 $ bodystyle        : chr  "convertible" "convertible" "hatchback" "sedan" ...
 $ drive.wheels     : chr  "rwd" "rwd" "rwd" "fwd" ...
 $ engine.location  : chr  "front" "front" "front" "front" ...
 $ wheel.base       : num  225 225 240 254 252 ...
 $ length           : num  429 429 435 449 449 ...
 $ width            : num  163 163 166 168 169 ...
 $ height           : num  124 124 133 138 138 ...
 $ curb.weight      : num  1156 1156 1280 1060 1281 ...
 $ engine.size      : num  2.13 2.13 2.49 1.79 2.23 ...
 $ compression.ratio: num  9 9 9 10 8 8.5 8.5 8.5 8.3 7 ...
 $ HP               : int  111 111 154 102 115 110 110 110 140 160 ...
 $ peak.rot         : int  5000 5000 5000 5500 5500 5500 5500 5500 5500 5500 ...
 $ city.distance    : num  8.93 8.93 8.08 10.2 7.65 ...
 $ highway.distance : num  11.48 11.48 11.05 12.75 9.35 ...
 $ n.cylinders      : int  4 4 6 4 5 5 5 5 5 5 ...
```

```r
auto$fuel &lt;- factor(auto$fuel)
```

---



```r
# dataset ridotto
names(auto)[which(names(auto)=="city.distance")] &lt;- "y"
vars &lt;- c("y", "engine.size","n.cylinders","curb.weight","fuel")
train &lt;- auto[,vars]
pairs(train[,-5], col=train$fuel)
```

![](Cars_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;

---


.pull-left[

```r
# y: istogramma
hist(train$y)
```

![](Cars_files/figure-html/unnamed-chunk-4-1.png)&lt;!-- --&gt;
]


.pull-right[

```r
# y: density plot
plot(density(train$y))
```

![](Cars_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;
]

---

.pull-left[

```r
# diagramma di dispersione
plot(y~engine.size, train, col=fuel) 
```

![](Cars_files/figure-html/unnamed-chunk-6-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
# jitter
plot(jitter(y)~jitter(engine.size), train, col=fuel) 
```

![](Cars_files/figure-html/unnamed-chunk-7-1.png)&lt;!-- --&gt;
]

---

`$$Y = \beta_1 + \beta_2 \mathrm{engine.size} + \beta_3 \mathrm{engine.size}^2 + \beta_4 \mathrm{engine.size}^3 + \beta_5 I\{\mathrm{fuel} = \mathrm{gas}\} + \varepsilon$$`


```r
fit1 &lt;- lm(y ~ poly(engine.size, degree=3, raw=T) + fuel, train)
```

![](Cars_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;

---

`$$1/y = \beta_1 + \beta_2 \mathrm{engine.size} +  \beta_3 I\{\mathrm{fuel} = \mathrm{gas}\}+ \varepsilon$$`


```r
fit2&lt;-lm(1/y ~ engine.size + fuel, train)
```

.pull-left[
![](Cars_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;
]

.pull-right[
![](Cars_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;
]


---

`$$\log(y) = \beta_1 + \beta_2 \log(\mathrm{engine.size}) +  \beta_3 I\{\mathrm{fuel} = \mathrm{gas}\} + \varepsilon$$`

```r
fit3 &lt;- lm(log(y) ~ log(engine.size) + fuel, train)
```

.pull-left[
![](Cars_files/figure-html/unnamed-chunk-14-1.png)&lt;!-- --&gt;
]

.pull-right[
![](Cars_files/figure-html/unnamed-chunk-15-1.png)&lt;!-- --&gt;
]

---

.pull-left[

```r
plot(fit3, which=1)
```

![](Cars_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
plot(fit3, which=4)
```

![](Cars_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;
]

---


```r
train[which(cooks.distance(fit3) &gt; .07), ]
```

```
       y engine.size n.cylinders curb.weight fuel
56 7.227      1.1471           2      1079.6  gas
57 7.227      1.1471           2      1079.6  gas
58 7.227      1.1471           2      1081.8  gas
59 6.802      1.3110           2      1134.0  gas
```

```r
table(train$n.cylinders)
```

```

  2   3   4   5   6   8  12 
  4   1 157  11  24   5   1 
```


---

$$
`\begin{aligned}
\log(y) = &amp; \beta_1 + \beta_2 \log(\mathrm{engine.size}) +  \beta_3 I\{\mathrm{fuel} = \mathrm{gas}\}  +\\ 
&amp; +\beta_4 \log(\mathrm{curb.weight})+ \beta_5I\{\mathrm{n.cylinders} = 2\} + \varepsilon
\end{aligned}`
$$


```r
# MSE.tr
fit1 = update(fit1, . ~ . +  log(curb.weight) + I(n.cylinders==2), train)
mean(resid(fit1)^2) 
```

```
[1] 1.07706
```

```r
fit2 = update(fit2, . ~ . +  log(curb.weight) + I(n.cylinders==2), train)
mean((train$y - 1/fitted(fit2))^2) 
```

```
[1] 1.143411
```

```r
fit3 = update(fit3, . ~ . +  log(curb.weight) + I(n.cylinders==2), train)
mean((train$y - exp(fitted(fit3)))^2) 
```

```
[1] 1.016788
```


---
layout: false
class: inverse, middle, center

# Not mtcars AGAIN

---

Esercizio tratto da https://supervised-ml-course.netlify.app/

![](images/SML.png)

---


```r
rm(list=ls())
library(readr)
cars2018 &lt;- read_csv("https://raw.githubusercontent.com/topepo/supervised-ML-case-studies-course/master/data/cars2018.csv")
library(tidyverse)
glimpse(cars2018)
```

```
Rows: 1,144
Columns: 15
$ Model                     &lt;chr&gt; "Acura NSX", "ALFA ROMEO 4C", "Audi R8 AWD",…
$ `Model Index`             &lt;dbl&gt; 57, 410, 65, 71, 66, 72, 46, 488, 38, 278, 2…
$ Displacement              &lt;dbl&gt; 3.5, 1.8, 5.2, 5.2, 5.2, 5.2, 2.0, 3.0, 8.0,…
$ Cylinders                 &lt;dbl&gt; 6, 4, 10, 10, 10, 10, 4, 6, 16, 8, 8, 8, 8, …
$ Gears                     &lt;dbl&gt; 9, 6, 7, 7, 7, 7, 6, 7, 7, 8, 8, 7, 7, 7, 7,…
$ Transmission              &lt;chr&gt; "Manual", "Manual", "Manual", "Manual", "Man…
$ MPG                       &lt;dbl&gt; 21, 28, 17, 18, 17, 18, 26, 20, 11, 18, 16, …
$ Aspiration                &lt;chr&gt; "Turbocharged/Supercharged", "Turbocharged/S…
$ `Lockup Torque Converter` &lt;chr&gt; "Y", "Y", "Y", "Y", "Y", "Y", "Y", "N", "Y",…
$ Drive                     &lt;chr&gt; "All Wheel Drive", "2-Wheel Drive, Rear", "A…
$ `Max Ethanol`             &lt;dbl&gt; 10, 10, 15, 15, 15, 15, 15, 10, 15, 10, 10, …
$ `Recommended Fuel`        &lt;chr&gt; "Premium Unleaded Required", "Premium Unlead…
$ `Intake Valves Per Cyl`   &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2,…
$ `Exhaust Valves Per Cyl`  &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2,…
$ `Fuel injection`          &lt;chr&gt; "Direct ignition", "Direct ignition", "Direc…
```

---


```r
ggplot(cars2018, aes(x = MPG)) +
    geom_histogram(bins = 25) +
    labs(x = "Fuel efficiency (mpg)",
         y = "Number of cars")
```

![](Cars_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;

---

# Train e test set


```r
car_vars &lt;- cars2018 %&gt;%
    select(-Model, -`Model Index`)

library(caret)
library(tidymodels)

car_split &lt;- car_vars %&gt;%
    initial_split(prop = 0.8,
                  strata = Aspiration)

car_train &lt;- training(car_split)
car_test &lt;- testing(car_split)
```

---

# lm e knn


```r
## specificazione di un modello lineare
mod_lm &lt;- linear_reg() %&gt;%
    set_engine("lm")

fit_lm &lt;- mod_lm %&gt;%
    fit(log(MPG) ~ ., 
        data = car_train)

## specificazione di un knn
mod_knn &lt;- nearest_neighbor() %&gt;%
    set_mode("regression") %&gt;%
    set_engine("kknn")

fit_knn &lt;- mod_knn %&gt;%
    fit(log(MPG) ~ ., 
        data = car_train)  
```

---


```r
results &lt;- car_test %&gt;%
    mutate(MPG = log(MPG)) %&gt;%
    bind_cols(predict(fit_lm, car_test) %&gt;%
                  rename(.pred_lm = .pred)) %&gt;%
    bind_cols(predict(fit_knn, car_test) %&gt;%
                  rename(.pred_knn = .pred))

# Valutazione sul test set
metrics(results, truth = MPG, estimate = .pred_lm)
```

```
# A tibble: 3 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard      0.0959
2 rsq     standard      0.831 
3 mae     standard      0.0723
```

```r
metrics(results, truth = MPG, estimate = .pred_knn)
```

```
# A tibble: 3 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard      0.102 
2 rsq     standard      0.813 
3 mae     standard      0.0715
```

---


```r
car_folds &lt;- vfold_cv(car_train, v = 10)

# Valutazione dei modelli con 10-fold CV
res_lm &lt;- mod_lm %&gt;%
    fit_resamples(
        log(MPG) ~ .,
        resamples = car_folds,
        control = control_resamples(save_pred = TRUE)
    )

res_knn &lt;- mod_knn %&gt;%
    fit_resamples(
        log(MPG) ~ .,
        resamples = car_folds,
        control = control_resamples(save_pred = TRUE)
    )
```

---


```r
results &lt;-  bind_rows(res_lm %&gt;%
                          collect_predictions() %&gt;%
                          mutate(model = "lm"),
                      res_knn %&gt;%
                          collect_predictions() %&gt;%
                          mutate(model = "knn"))

head(results)
```

```
# A tibble: 6 × 6
  id     .pred  .row `log(MPG)` .config              model
  &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt;                &lt;chr&gt;
1 Fold01  3.12    17       2.94 Preprocessor1_Model1 lm   
2 Fold01  3.12    26       2.89 Preprocessor1_Model1 lm   
3 Fold01  2.90    32       2.89 Preprocessor1_Model1 lm   
4 Fold01  2.90    35       2.89 Preprocessor1_Model1 lm   
5 Fold01  2.69    36       2.94 Preprocessor1_Model1 lm   
6 Fold01  3.17    52       3.04 Preprocessor1_Model1 lm   
```

---


```r
results %&gt;%
    ggplot(aes(`log(MPG)`, .pred)) +
    geom_abline(lty = 2, color = "gray50") +
    geom_point(size = 1.5, alpha = 0.3)+
    geom_smooth(method = "lm") +
    facet_wrap(~ model)
```

![](Cars_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
