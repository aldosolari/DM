---
title: "Data Mining"
subtitle: "Il modello e il processo di modellizzazione"
author: Aldo Solari
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      ratio: '16:9'
---

```{r startup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo=T, eval=T, message=F, warning=F, error=F, comment=NA)
```


# Il processo di analisi dei dati


<center>
![](images/data-science-model.svg)
</center>
.center[Figure 1.2 del libro KS]


* Prima di tutto, bisogna considerare il processo (spesso sottovalutato) di **pulizia dei dati**

* Successivamente bisogna **capire i dati**. Questa fase viene chiamata *analisi esplorativa dei dati*. 

---

# Analisi esplorativa dei dati

<center>
![](images/data-science-model.svg)
</center>
.center[Figure 1.2 del libro KS]


* *Exploratory Data Analysis* (termine coniato da J. Tukey, abbreviato in EDA) comprende le operazioni di 

  * **visualizzazione**
  * **trasformazione** 
  * **modellizzazione**

* Tuttavia non ci sono regole ben definite. EDA è fondamentalmente un processo **creativo**.

---

# Visualizzazione, trasformazione e modellizzazione dei dati

Il libro di [Wickham e Grolemund (2016)](https://r4ds.had.co.nz/) [WG] illustra queste operazioni

* __La visualizzazione dei dati__ è un ottimo punto di partenza: ci consente di costruire grafici informativi che aiutano a comprendere i dati (WG, sezione 3)

* __La trasformazione dei dati__ ci consente di creare nuove variabili (*feature engineering*), di escludere le osservazioni anomale, etc. (WG, sezione 5)

* __La modellizzazione dei dati__ rende (matematicamente) precisa la relazione tra le variabili (WG, sezioni 22-25)

* EDA (WG, section 7) è un processo **iterativo**
    * Poniti delle domande sui tuoi dati.
    * Cerca le risposte visualizzando, trasformando e modellando i tuoi dati.
    * Usa ciò che impari per perfezionare le tue domande e/o generare nuove domande.

---

# Il processo di modellizzazione 

* Il processo di modellizzazione è anch'esso un processo **iterativo**.

* Il **modello** *per sé* rappresenta una minima parte del processo di modellizzazione.

* Le fasi principali comprendono

    * *Exploratory data analysis* 
    * *Feature engineering* 
    * *Model fitting / tuning*
    * *Model evaluation*

---

<center>
![](images/modeling-process.svg)
</center>
.center[Figure 1.3 del libro KS]


---

layout: false
class: inverse, middle, center

# Caso studio: Chicago Train Ridership Data

---

Figure 4.1: Chicago Transit Authority ‘L’ map. For this illustration, we are interesting in predicting the ridership at the Clark/Lake station in the Chicago Loop.

```{r, echo=FALSE,  out.width = '50%'}
knitr::include_graphics("images/Chicago_L_diagram_sb.png")
```

---

# Chicago Train Ridership Data

* Nel capitolo 4 di KJ (e capitoli successivi), viene discussa la modellizzazione del il numero di utenti giornalieri alla stazione di Clark/Lake del sistema ferroviario pubblico di Chicago 

* I predittori utilizzati sono le date del calendario, la serie storica del numero di utenti nelle varie stazioni, il tempo atmosferico e altri fattori

* Il processo di modellizzazione può essere esemplificato con il seguente "monologo interiore" 

---

| Riflessione   | Attività      |
|----------|:-------------:|
| I valori del numero di utenti nelle diverse stazioni sono estremamente correlati.|  EDA |
| I valori del numero di utenti nei giorni feriali e nel fine settimana sono molto diversi. |  EDA |
| Il giorno 11 Giugno 2010 ha un valore estremamente elevato di utenze. |  EDA |
| Quali stazioni presentano i valori più bassi? |  EDA |
| Le date dovrebbero essere codificate come giorno della settimana e anno.  |  Feature engineering |
| Forse i predittori fortemente correlati potrebbero essere rappresentati con una PCA.  |  Feature engineering |
| Le registrazioni meteorologiche orarie potrebbero essere riassunte in misurazioni giornaliere.  |  Feature engineering |
| Iniziamo con una regressione lineare, $k$-vicini più vicini e un *boosting* di alberi decisionali.  |  Model fitting |
| Quanti vicini $k$ usare?  |  Model tuning |
| Quante iterazioni di *boosting*? Poche o tante?  |  Model tuning |
| Quali modelli hanno il MSE più basso? | Model evaluation |
| Quali giorni sono stati previsti in modo non soddifacente?  |  EDA |

---

| Riflessione   | Attività      |
|----------|:-------------:|
| I punteggi di importanza delle variabili indicano che le informazioni meteorologiche non sono predittive. Li scarteremo dalla prossima serie di modelli.  |  Model evaluation |
| Sembra che dovremmo concentrarci su molte iterazioni di *boosting*.|  Model evaluation |
| Abbiamo bisogno di codificare le festività per migliorare le previsioni su (e intorno a) quelle date |  Feature engineering |
| Eliminiamo $k$-NN dall'elenco dei modelli |  Model evaluation |

---

Figure 4.3: Distribution of daily ridership at the Clark/Lake stop from 2001 to 2016. The histogram (a) allows us to see that there are two peaks or modes in ridership distribution indicating that there may be two mechanisms affecting ridership. The box plot (b) does not have the ability to see multiple peaks in the data. However the violin plot (c) provides a compact visualization that identifies the distributional nuance.

```{r, echo=FALSE,  out.width = '60%'}
knitr::include_graphics("images/eda-s-40380-distribution-1.svg")
```

---

Figure 4.4: Distribution of weekday ridership at all stations other than Clark/Lake during 2016.


```{r, echo=FALSE,  out.width = '100%'}
knitr::include_graphics("images/Fig_4_4.jpg")
```

---

Figure 4.5: Distribution of daily ridership at the Clark/Lake stop from 2001 to 2016 colored and faceted by weekday and weekend. Note that the y-axis counts for each panel are on different scales and the long left tail in the weekday data.

```{r, echo=FALSE,  out.width = '60%'}
knitr::include_graphics("images/eda-s-40380-distribution-POW-1.svg")
```

---

Figure 4.6: A scatter plot of the 14-day lag ridership at the Clark/Lake station and the current-day ridership at the same station.

```{r, echo=FALSE,  out.width = '50%'}
knitr::include_graphics("images/eda-s-40380-vs-l14-s40380-1.svg")
```

---

Figure 4.7: Heat map of ridership from 2001 through 2016 for weekdays that have less than 10,000 rides at the Clark/Lake station. This visualization indicates that the distinct patterns of low ridership on weekdays occur on and around major US holidays.


```{r, echo=FALSE,  out.width = '50%'}
knitr::include_graphics("images/eda-s-40380-low-weekday-1.svg")
```

---

Figure 4.8: Two-week lag in daily ridership versus daily ridership for the Clark/Lake station with common US holidays excluded and colored by part of the week.

```{r, echo=FALSE,  out.width = '50%'}
knitr::include_graphics("images/eda-weekly-lag-1.svg")
```

---

Figure 4.9: Visualization of the correlation matrix of the 14-day lag ridership station predictors for non-holiday, weekdays in 2016. Stations are organized using hierarchical cluster analysis, and the organizational structure is visualized using a dendrogram (top and right).

```{r, echo=FALSE,  out.width = '70%'}
knitr::include_graphics("images/correlation.png")
```

---

Figure 4.10: Monthly average ridership per year by weekday (excluding holidays) or weekend.

```{r, echo=FALSE,  out.width = '100%'}
knitr::include_graphics("images/eda-monthly-ridership-1.svg")
```


---


Figure 4.11: Monthly average gas price per gallon (USD) per year. Prices spike in the summer of 2008, which is at the same time that weekend ridership spikes.

```{r, echo=FALSE,  out.width = '70%'}
knitr::include_graphics("images/eda-monthly-gas-prices-1.svg")
```


---

Figure 4.13: Principal component analysis of the 14-day station lag ridership. (a) The cumulative variability summarized across the first 10 components. (b) A scatter plot of the first two principal components. The first component focuses on variation due to part of the week while the second component focuses on variation due to time (year). (c) The relationship between the first principal component and ridership for each day of the week at the Clark/Lake station. (d) The relationship between second principal component and ridership for each year at the Clark/Lake station.

```{r, echo=FALSE,  out.width = '40%'}
knitr::include_graphics("images/eda-PCA-stations-1.svg")
```
---

# Columns vs features

Figure 1.7: A series of model and feature set combinations for modeling train ridership in Chicago.

```{r, echo=FALSE,  out.width = '60%'}
knitr::include_graphics("images/Fig_1_7.png")
```

---

* Set 1 - dates (4)
    - `dow` (Mon, Tue, .., Sun)
    - `doy` (1,2,..., 366)
    - `week` (1,2,..., 53)
    - `month` (Jan, Feb,.., Dec) 
* Set 2 - 14-day lag predictors (125)
* Set 3 - other lag predictors (875)
* Set 4 - weather predictors  (18)
* Set 5 - holiday binary predictors (55)

---

Figure 3.12: The effect of adding holiday predictors to an SVM model created for the Chicago train data. The dashed line corresponds to the model of the original predictors. The solid line corresponds to the model when an indicator of holiday was included as a predictor.

```{r, echo=FALSE,  out.width = '100%'}
knitr::include_graphics("images/review-svm-xmas-1.svg")
```

---

Figure 4.19: (a) The distribution of residuals from the model resampling process for the base model and the base model plus other potentially useful predictors for explaining ridership at the Clark/Lake station. (b) The partial regression plot for the effect of part of the week. (c) The partial regression plot for the 14-day lag predictor of the Clark/Lake station. (d) The partial regression plot for holiday classification.

```{r, echo=FALSE,  out.width = '40%'}
knitr::include_graphics("images/eda-chicago-linear-models-1.svg")
```


---

layout: false
class: inverse, middle, center

# Pre-processamento dei dati e *feature engineering*

---


# Pre-processamento dei dati

* **dummy** : i predittori qualitativi richiedono una codifica numerica?

* **zv** : le colonne a varianza (quasi) zero devono essere rimosse?

* **impute** : se mancano alcuni valori, dovrebbero essere imputati?

* **decorrelate** : se ci sono predittori correlati, questa correlazione dovrebbe essere mitigata? Ciò potrebbe significare filtrare i predittori, utilizzare l'analisi delle componenti principali o una tecnica basata su modelli (ad esempio la regolarizzazione)

* **normalize** : i predittori devono essere centrati e riscalati?

* **trasform** : è utile trasformare i predittori in modo che siano più simmetrici?

Si veda l'Appendice del libro KS

---

![](images/model_preprocessing.png)

---

# Pre-processamento dei dati e feature engineering

![](images/fe_venn.svg)

Si veda https://topepo.github.io/2021_11_HDSI_RUG/#1


