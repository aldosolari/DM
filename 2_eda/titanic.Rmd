---
title: "Exploratory Data Analysis: Titanic data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/aldosolari/Desktop/DM_off/2_eda/code")
```

## Import data

```{r, message=FALSE, warning=FALSE}
train <- read.csv("titanic_tr.csv", 
         header = TRUE, stringsAsFactors = FALSE)
test <- read.csv("titanic_te.csv", 
         header = TRUE, stringsAsFactors = FALSE)
```

## Type of variables


```{r, message=FALSE, warning=FALSE}
# combine data sets
combi <- rbind(train, test)

# check type of variables
str(combi)

# http://biostat.mc.vanderbilt.edu/twiki/pub/Main/DataSets/titanic3info.txt 

# convert pclass, sex, embarked to factors
combi$pclass <- as.factor(combi$pclass)
combi$sex <- as.factor(combi$sex)
combi$embarked <- as.factor(combi$embarked)

# copy of the response as a factor for better readability
combi$survived01 <- combi$survived
combi$survived <- as.factor(combi$survived01)
levels(combi$survived) = c("Death","Alive")

```

## Missing values

```{r, message=FALSE, warning=FALSE}
# cabin has missing values coded as "" instead of NA
combi$cabin[combi$cabin==""] <- NA

# where are the missing values?
summary(combi)

# fare: 1 missing value
# embarked: 2 missing values
# age: 20% missing values
# cabin: 77% missing values
```

## Imputing missing values

```{r, message=FALSE, warning=FALSE}
# 2 passengers with missing values on embarked
combi[which(is.na(combi$embarked)), ]
# We see that the 2 passengers paid $80 and their classes are 1st. So from where did they embark?
boxplot(fare~ pclass + embarked, data=combi); abline(h=80)
# The median fare for a first class passenger departing from Charbourg coincides nicely with the $80 paid by our embarkment-deficient passengers. I think we can safely replace the NA values with Cherbourg
combi$embarked[which(is.na(combi$embarked))] <- c("C","C")

# 1 passenger with missing value on fare
combi[which(is.na(combi$fare)), ]
# It should be fine to replace the missing value with the median value among passengers travelling 3rd class and embarked from Southampton
aggregate(fare ~ pclass + embarked, combi, FUN=median)
combi$fare[which(is.na(combi$fare))] <- 8.0500

# Age by pclass and sex
aggregate(age ~ pclass + sex, combi, FUN=mean)
# Model age as a function of pclass and sex
fit.age <- lm(age ~ sex + pclass, 
          data = combi[!is.na(combi$age),])
# Imputation of age missing values
combi$age[is.na(combi$age)] <- predict(fit.age, 
          newdata=combi[is.na(combi$age),])
```

## Back to training and test

```{r, message=FALSE, warning=FALSE}
n = nrow(train)
m = nrow(test)

train <- combi[1:n,]
test <- combi[(n+1):(n+m),]
```

## Data visualization

```{r, message=FALSE, warning=FALSE}
# survived ~ pclass
plot(survived~pclass, train)

# survived ~ age
plot(survived ~ age, train)

library(ggplot2)
ggplot(train, aes(x=age, y=survived01)) + geom_jitter(height = 0.05) + geom_smooth()
```

## rpart

```{r, message=FALSE, warning=FALSE}
library(rpart)
fit.rpart <- rpart(survived ~ pclass + age, train, 
               control=rpart.control(maxdepth =  3))
                   
library(rpart.plot)
rpart.plot(fit.rpart, type=0, extra=2)
yhat <- predict(fit.rpart, newdata=test, type="class")

# confusion matrix
table(yhat, test$survived)

# accuracy
mean(yhat == test$survived)
```

## Back to data visualization: + sex

```{r, message=FALSE, warning=FALSE}
library(ggplot2)

# visualize the relationship of sex and pclass with survival
ggplot(train, aes(x = sex, fill = survived)) + geom_bar() + facet_wrap(~ pclass) 

# visualize the relationship of sex, pclass, age with survival
ggplot(train, aes(x = age, fill = survived)) + facet_wrap(~sex + pclass) + geom_histogram(binwidth = 10)
```

## Data transformation

```{r, message=FALSE, warning=FALSE}
# passenger title is contained within the passenger name
combi$name[1]
# create a new variable title (feature engineering)

library(dplyr)
library(stringr)
combi <- combi %>% 
     mutate(title = str_extract(name, "[a-zA-Z]+\\."))
table(combi$title)

# some titles can be merged together
titles <- data.frame(title = c("Mr.", "Capt.", "Col.", "Don.", "Dr.", "Jonkheer.", "Major.", "Rev.", "Sir.",
                               "Mrs.", "Dona.", "Lady.", "Mme.", "Countess.",
                               "Miss.", "Mlle.", "Ms.",
                               "Master."),
                     title2 = c(rep("Mr.", 9),
                                rep("Mrs.", 5),
                                rep("Miss.", 3),
                                "Master."),
                            stringsAsFactors = FALSE)

titles 

# create title2
combi <- combi %>%
  left_join(titles, by = "title")

# check title2 by using sex
combi %>%
  filter((sex == "female" & (title2 == "Mr." | title2 == "Master.")) |
           (sex == "male" & (title2 == "Mrs." | title2 == "Miss.")))

# fix Dr. Alice
which(combi$name=="Leader, Dr. Alice (Farnham)")
combi$title2[797] <- "Mrs."
combi$title2 <- as.factor(combi$title2)

# Visualize the relationship of pclass and title with survival
ggplot(combi[1:891,], aes(x = title2, fill = survived)) +
  geom_bar() +
  facet_wrap(~pclass) + 
  ggtitle("Pclass") +
  xlab("Title") +
  ylab("Total Count") +
  labs(fill = "Survived")

# Create a family size variable including the passenger themselves
combi$fsize <- combi$sibsp + combi$parch + 1

# the first character of cabin is the deck
table(substr(combi$cabin, 1, 1))
```

![Use of external informations: Titanic's decks](
https://s-media-cache-ak0.pinimg.com/564x/c0/90/c9/c090c97680e8e5050942287e68abafe8.jpg)



## Modeling

```{r, message=FALSE, warning=FALSE}
# back to training and test
n = nrow(train)
m = nrow(test)
train <- combi[1:n,]
test <- combi[(n+1):(n+m),]

# model survived as a function of pclass + sex + age + sibsp + parch
library(party)
fit <- ctree(survived ~ pclass + sex + age + sibsp + parch, data = train)
plot(fit)
yhat <- predict(fit,newdata=test,type="response")
table(yhat, test$survived)
mean(yhat == test$survived)

# model survived as a function of pclass + title2 + fsize
fit2 <- ctree(survived ~ pclass + title2 + fsize, data = train)
plot(fit2)
yhat2 <- predict(fit2,newdata=test,type="response")
table(yhat2, test$survived)
mean(yhat2 == test$survived)
```
